@page "/searchbuspackages"
@layout UserLayout
@rendermode InteractiveServer
@inject NavigationManager NavManager

@using Entities
@inject Services.IBusPackageService BusPackageService

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <span class="text-black-50">Search Buses </span>

            <div class="row mb-3">
                <!-- Max Price -->
                <div class="col-md-4">
                    <input type="number" class="form-control" placeholder="Enter Max Price" @bind="searchPrice" />
                </div>

                <!-- Duration -->
                <div class="col-md-4">
                    <select class="form-select" @bind="searchDuration">
                        <option value="">---Select Duration---</option>
                        <option value="1 Hour">1 Hour</option>
                        <option value="5 Hour">5 Hour</option>
                        <option value="1 Day">1 Day</option>
                        <option value="3 Days">3 Days</option>
                        <option value="1 Week">1 Week</option>
                        <option value="1 Month">1 Month</option>
                    </select>
                </div>

                <!-- Search/Cancel -->
                <div class="col-md-4">
                    <button class="btn btn-dark w-70" @onclick="SearchBusPackages">Search</button>
                    <button class="btn btn-danger w-30" @onclick="CancelSearch">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

@if (loading)
{
    <p>Loading...</p>
}
else if (packageResults == null)
{
    <!-- Show all packages initially -->
    <div class="container">
        <div class="row">
            @foreach (var p in allPackages)
            {
                <div class="col-md-3 d-flex">
                    <div class="card mb-3 shadow-sm h-100 w-100">
                        <img src="@p.BusImage" class="card-img-top" alt="Bus Image" style="height:180px; object-fit:cover;">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@p.BusMake @p.BusModel</h5>
                            <p class="card-text flex-grow-1">
                                Price: Rs. @p.Price <br />
                                Duration: @p.Duration <br />
                                With Driver: @(p.WithDriver ? "Yes" : "No")
                            </p>

                            <button class="btn btn-dark mt-auto"
                                    @onclick="() => GoToBusDetails(p.BusId)">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}
else if (!packageResults.Any())
{
    <div class="container">
        <div class="alert alert-warning">No buses found for given filters.</div>
    </div>
}
else
{
    <!-- Show search results -->
    <div class="container">
        <div class="row">
            @foreach (var p in packageResults)
            {
                <div class="col-md-3 d-flex">
                    <div class="card mb-3 shadow-sm h-100 w-100">
                        <img src="@p.BusImage" class="card-img-top" alt="Bus Image" style="height:180px; object-fit:cover;">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@p.BusMake @p.BusModel</h5>
                            <p class="card-text flex-grow-1">
                                Price: Rs. @p.Price <br />
                                Duration: @p.Duration <br />
                                With Driver: @(p.WithDriver ? "Yes" : "No")
                            </p>

                            <button class="btn btn-dark mt-auto"
                                    @onclick="() => GoToBusDetails(p.BusId)">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}


<section class="container-fluid bg-dark fixed-bottom pt-2">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="card bg-transparent text-secondary">
                    <div class="card-body">
                        <div class="mb-2">
                            <img src="/logowhitered.png" height="20" />
                            <span class="small">&copy; 2025 GoRent. All rights reserved.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


@code {
    private decimal? searchPrice;
    private string searchDuration = "";

    private bool loading = false;
    private List<EntBusPackage>? packageResults;
    private List<EntBusPackage>? allPackages;

    private async Task SearchBusPackages()
    {
        loading = true;
        packageResults = await BusPackageService.SearchBusPackagesAsync(searchPrice, searchDuration);
        loading = false;
    }

    private async Task CancelSearch()
    {
        searchPrice = null;
        searchDuration = "";
        loading = true;
        packageResults = null;
        allPackages = await BusPackageService.GetAllAsync();
        loading = false;
    }

    private void GoToBusDetails(string busId)
    {
        NavManager.NavigateTo($"/busdetails/{busId}");
    }

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        allPackages = await BusPackageService.GetAllAsync();
        loading = false;
    }
}
