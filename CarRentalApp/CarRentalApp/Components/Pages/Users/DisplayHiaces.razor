@page "/searchhiacepackages"
@layout UserLayout
@rendermode InteractiveServer
@inject NavigationManager NavManager

@using Entities
@inject IHiacePackageService ServiceHiacePackage

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <span class="text-black-50">Search Hiaces</span>

            <div class="row mb-3">

                <!-- Max Price -->
                <div class="col-md-4">
                    <input type="number" class="form-control" placeholder="Enter Max Price" @bind="searchPrice" />
                </div>

                <!-- Duration -->
                <div class="col-md-4">
                    <select class="form-select" @bind="searchDuration">
                        <option value="">---Select Duration---</option>
                        <option value="1 Hour">1 Hour</option>
                        <option value="5 Hour">5 Hour</option>
                        <option value="1 Day">1 Day</option>
                        <option value="3 Days">3 Days</option>
                        <option value="1 Week">1 Week</option>
                        <option value="1 Month">1 Month</option>
                    </select>
                </div>

                <!-- Search/Cancel Buttons -->
                <div class="col-md-4">
                    <button class="btn btn-dark w-70" @onclick="SearchHiacePackages">Search</button>
                    <button class="btn btn-danger w-30" @onclick="CancelSearch">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

@if (loading)
{
    <p>Loading...</p>
}
else if (packageResults == null)
{
    <!-- Show all packages initially -->
    <div class="container">
        <div class="row">
            @foreach (var p in allPackages)
            {
                <div class="col-md-3 d-flex">
                    <div class="card mb-3 shadow-sm h-100 w-100">
                        <img src="@p.HiaceImage" class="card-img-top" alt="Hiace Image" style="height:180px; object-fit:cover;">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@p.HiaceMake @p.HiaceModel</h5>
                            <p class="card-text flex-grow-1">
                                Price: Rs. @p.Price <br />
                                Duration: @p.Duration <br />
                                With Driver: @(p.WithDriver ? "Yes" : "No")
                            </p>

                            <!-- Details Button -->
                            <button class="btn btn-dark mt-auto"
                                    @onclick="() => GoToHiaceDetails(p.HiaceId)">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}
else if (!packageResults.Any())
{
    <!-- No search results -->
    <div class="container">
        <div class="alert alert-warning" role="alert">
            No hiaces found for given filters.
        </div>
    </div>
}
else
{
    <!-- Show search results -->
    <div class="container">
        <div class="row">
            @foreach (var p in packageResults)
            {
                <div class="col-md-3 d-flex">
                    <div class="card mb-3 shadow-sm h-100 w-100">
                        <img src="@p.HiaceImage" class="card-img-top" alt="Hiace Image" style="height:180px; object-fit:cover;">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@p.HiaceMake @p.HiaceModel</h5>
                            <p class="card-text flex-grow-1">
                                Price: Rs. @p.Price <br />
                                Duration: @p.Duration <br />
                                With Driver: @(p.WithDriver ? "Yes" : "No")
                            </p>

                            <!-- Details Button -->
                            <button class="btn btn-dark mt-auto"
                                    @onclick="() => GoToHiaceDetails(p.HiaceId)">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<section class="container-fluid bg-dark fixed-bottom pt-2">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="card bg-transparent text-secondary">
                    <div class="card-body">
                        <div class="mb-2">
                            <img src="/logowhitered.png" height="20" />
                            <span class="small">&copy; 2025 GoRent. All rights reserved.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
@code {
    private decimal? searchPrice;
    private string searchDuration = "";

    private bool loading = false;
    private List<EntHiacePackage>? packageResults;
    private List<EntHiacePackage>? allPackages;

    private async Task SearchHiacePackages()
    {
        loading = true;
        packageResults = await ServiceHiacePackage.SearchHiacePackagesAsync(searchPrice, searchDuration);
        loading = false;
    }

    private async Task CancelSearch()
    {
        searchPrice = null;
        searchDuration = "";

        loading = true;
        packageResults = null; // clear search results
        allPackages = await ServiceHiacePackage.GetAllAsync(); // reload all hiace packages
        loading = false;
    }

    private void GoToHiaceDetails(string hiaceId)
    {
        NavManager.NavigateTo($"/hiacedetails/{hiaceId}");
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            loading = true;
            allPackages = await ServiceHiacePackage.GetAllAsync(); // load all initially
            loading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading hiace packages: {ex.Message}");
        }
    }
}
